{% extends 'cotravelling/base_navbar.html' %}

{% block title %}Доступные поездки{% endblock title %}

{% load sass_tags %}

{% block css %}
<link href="{% sass_src 'cotravelling/scss/available_trips.scss' %}" rel="stylesheet" type="text/css" />
{% endblock css %}


{% block content %}
{% if auth %}
<form action="{{ request.get_full_path }}" method="post">
    {% csrf_token %}
    <div class="container add_trip_box mt-2">
        <div class="row no-gutters">
            <div class="col-lg-3 col-md-6 col-sm-12 mb-1">
                <div class="input_box" id="from">
                    <select class="selectpicker" data-live-search="true" name="source" required>
                        <option disabled selected value="">Откуда</option>
                        <option>1 общежитие</option>
                        <option>2 общежитие</option>
                        <option>3 общежитие</option>
                        <option>4 общежитие</option>
                        <option>6 общежитие</option>
                        <option>7 общежитие</option>
                        <option>8 общежитие</option>
                        <option>9 общежитие, любой подъезд</option>
                        <option>9 общежитие, 1 подъезд</option>
                        <option>9 общежитие, 2 подъезд</option>
                        <option>9 общежитие, 3 подъезд</option>
                        <option>9 общежитие, 4 подъезд</option>
                        <option>10 общежитие</option>
                        <option>11 общежитие</option>
                        <option>12 общежитие</option>
                        <option>Площадь перед НК</option>
                        <option>КПМ</option>
                        <option>Додо пицца</option>
                        <option>Метро Ховрино</option>
                        <option>Метро Алтуфьево</option>
                        <option>IKEA</option>
                        <option>Metro</option>
                        <option>Окей</option>
                        <option>Рио</option>
                        <option>Мираторг</option>
                    </select>  
                </div>  
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-1">
                <div class="input_box" id="to">
                    <select class="selectpicker align-self-center" data-live-search="true" name="target" required>
                        <option disabled selected value="">Куда</option>
                        <option>1 общежитие</option>
                        <option>2 общежитие</option>
                        <option>3 общежитие</option>
                        <option>4 общежитие</option>
                        <option>6 общежитие</option>
                        <option>7 общежитие</option>
                        <option>8 общежитие</option>
                        <option>9 общежитие, любой подъезд</option>
                        <option>9 общежитие, 1 подъезд</option>
                        <option>9 общежитие, 2 подъезд</option>
                        <option>9 общежитие, 3 подъезд</option>
                        <option>9 общежитие, 4 подъезд</option>
                        <option>10 общежитие</option>
                        <option>11 общежитие</option>
                        <option>12 общежитие</option>
                        <option>Площадь перед НК</option>
                        <option>КПМ</option>
                        <option>Додо пицца</option>
                        <option>Метро Ховрино</option>
                        <option>Метро Алтуфьево</option>
                        <option>IKEA</option>
                        <option>Metro</option>
                        <option>Окей</option>
                        <option>Рио</option>
                        <option>Мираторг</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 mb-1">
                <div class="input_box" id="vehicle">
                    <select class="selectpicker" data-live-search="true" name="vehicle" required>
                        <option disabled selected value="">На чём</option>
                        <option>Такси</option>
                        <option>Каршеринг</option>
                        <option>Своя машина</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-1 col-md-4 col-sm-6 col-6 mb-1">
                <div class="input_box" id="count">
                    <input id="people_count" type="number" min="1" max="10" name="free_places" placeholder="Мест" class="form-control" required/>
                </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-12">
                <div class="input_box" id="date">
                    <div class="form-group" style="margin-bottom: 0; width: 100%">
                        <div class="input-group date" id="datetimepicker" data-target-input="nearest">
                            <input type="text" class="form-control datetimepicker-input" data-target="#datetimepicker" name="datetime" placeholder="Когда" autocomplete="off" required maxlength=16/>
                            <div class="input-group-append" data-target="#datetimepicker" data-toggle="datetimepicker">
                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                <script type="text/javascript">
                    $(function () {
                        $('#datetimepicker').datetimepicker({
                            locale: 'ru'
                        });
                    });
                </script>
                <style>
                    .bootstrap-datetimepicker-widget.dropdown-menu { width: auto !important; }
                    .bootstrap-datetimepicker-widget table td.cw {
            font-size: .25em;
            height: 40px;
            line-height: 40px;
            color: #6c757d; }
                </style>
            </div>
        </div>
        <div class="row mt-2 text-right">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="customCheck1" name="is_closed"/>
                    <label class="custom-control-label" for="customCheck1">Хочу предварительно подтверждать участников</label>
                </div>
            </div>
        </div>
        <div class="row mt-2 justify-content-center">
            <div class="col-lg-3 col-md-6 col-sm-12 col-12 text-center">
                <button type="submit" class="btn_action" name="add_trip" required>Добавить поездку</button>
            </div>
        </div>
    </div>
</form>
{% endif %}

<div class="container-fluid trip_lists_container mt-4">
    <div class="row justify-content-between">
        <div class="col-lg-4 col-0 d-none d-lg-block align-self-center">предыдущие три дня</div>
        <div class="col-lg-4 col-12 text-center align-self-center">
            <h2 class="d-inline">Доступные поездки</h2>
        </div>
        <div class="col-lg-4 col-4 d-none d-lg-block text-right align-self-center">следующие три дня</div>
    </div>
    <div class="row">
        
    {% for trip_column_date in trips %}
        {% if trip_column_date.iteration == 0 %}
        <div class="mobile_content col-12 col-lg-4">
        {% else %}
        <div class="d-none d-lg-block col-lg-4">
        {% endif %}
                {% for trip in trip_column_date.trips %}
                <div class="card card_default"> <!-- One crad for one trip -->
                    <div class="container trip_container">
                        <div class="row">
                            <div class="from_to_block col-xl-4 col-lg-5 d-flex flex-column align-items-start col-12" style="padding-right: 0;"> <!-- From, to, when, vehicle -->
                                <div>
                                    <span class="field_hint">Откуда</span>
                                    <h6>{{trip.source}}</h6>
                                </div>
                                <div class="to_block mt-auto">
                                    <span class="field_hint">Куда</span>
                                    <h6>{{trip.target}}</h6>
                                </div>
                            </div>
                            <div class="path col-xl-1 col-lg-1 col-12 d-flex flex-column align-items-center" style="padding-left: 0; padding-right: 0;">
                                <img src="../../static/cotravelling/img/circle.svg" class="circle_point start_circle_point"/>
                                <div class="rect_path"></div>
                                <img src="../../static/cotravelling/img/circle.svg" class="circle_point end_circle_point"/>
                            </div>
                            <div class="col-xl-3 col-lg-6 d-flex flex-column align-items-start col-12 info_container" style="padding-left: 0; padding-right: 0;">
                                <div class="info_block">
                                    <span>{{trip.time}}</span>
                                    <span>{{trip_column_date.date}}</span>
                                </div>
                                <div class="info_block trip_vehicle mt-auto">
                                    <span>{{trip.vehicle}}</span>
                                </div>
                            </div>
                            <div class="col-xl-4 col-lg-12 participants_container"> <!-- Participants -->
                                <span class="field_hint">Участники</span>
                                <div class="participants d-flex flex-wrap justify-content-between">
                                    {% for user in trip.users %}
                                    <span>{{ user }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="row justify-content-center text-center">
                            <div class="col-xl-12 col-lg-12 col-12 d-block">
                                {% if trip.free_places > 0 %}
                                    {% if auth %}
                                    <form id="button_form" action="{{ request.get_full_path }}" method="post">
                                        {% csrf_token %}
                                    </form>
                                    {% include "cotravelling/card_buttons.html" %}
                                    {% endif %}
                                {% else %}
                                    <h6>Свободных мест нет</h6>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="card card_default card_empty text-center">
                    <h4>Поездок не запланировано</h4>
                </div>
                {% endfor %}
        </div>
        {% endfor %}
<!--        -->
    </div>
    <script>
        var until_date = "{{until_date}}";
        var user = {{ user.id }};
    </script>
</div>

<script>
    function load() {
        console.log("load");
        $.ajax({
            url: "/load_trips/" + until_date + "/" + user,
            success: function(result) {
                if (result["date"] == undefined) {
                    console.log(result);
                }
                console.log(result["date"] + " " + until_date);
                if (result["date"] == window.until_date) {
                    $("#days_list").append(result["page"]);
                    window.until_date = result["new_date"];
                }
            },
        });
        
    }

</script>

{% endblock content %}
